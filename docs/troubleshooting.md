# トラブルシューティング

Screen Share Viewerの使用中に発生する可能性のある問題と解決方法をまとめています。

## 画面共有が開始できない

### エラー: NotAllowedError

**症状**:
```
画面共有を開始できませんでした

エラー: NotAllowedError
詳細: Permission denied
```

**原因**: ブラウザに画面収録の権限が付与されていません。

**対処法 (macOS)**:

1. **システム設定を開く**
   ```
   システム設定 > プライバシーとセキュリティ > 画面収録
   ```

2. **ブラウザに権限を付与**
   - 使用しているブラウザ（Chrome、Safari、Firefox等）を探す
   - チェックボックスをONにする
   - 左下の鍵アイコンをクリックして変更を保存

3. **ブラウザを完全に再起動**
   ```bash
   # Chromeの場合
   killall "Google Chrome"

   # Safariの場合
   killall Safari
   ```

   または `Cmd + Q` でブラウザを完全終了してから再起動

4. **アプリケーションを再度開いて画面共有を試す**

**対処法 (Windows)**:

Windows 10/11ではブラウザレベルの権限のみ必要です:
1. ブラウザが画面共有を要求した際に「許可」をクリック
2. 常に許可する場合は、ブラウザの設定から該当サイトの権限を確認

---

### エラー: TypeError

**症状**:
```
画面共有を開始できませんでした

エラー: TypeError
詳細: getDisplayMedia must be called with valid constraints.
```

**原因**: ブラウザがサポートしていない制約が指定されています。

**対処法**:
このエラーは最新版のコードでは修正済みです。以下を確認してください:

1. **ブラウザを最新版に更新**
2. **キャッシュをクリア**
   - Chrome: `Cmd + Shift + Delete` (macOS) / `Ctrl + Shift + Delete` (Windows)
   - ハードリロード: `Cmd + Shift + R` (macOS) / `Ctrl + Shift + R` (Windows)

3. **開発サーバーを再起動**
   ```bash
   # サーバーを停止 (Ctrl + C)
   # 再起動
   npm run dev
   ```

---

### エラー: NotSupportedError

**症状**:
```
このブラウザは画面共有をサポートしていません
```

**原因**: 使用しているブラウザが Screen Capture API に対応していません。

**対処法**:

対応ブラウザの最新版を使用してください:
- Google Chrome 72以降
- Microsoft Edge 79以降
- Safari 13以降 (macOS 10.15以降)
- Firefox 66以降

---

### エラー: NotFoundError

**症状**:
```
画面共有可能なディスプレイが見つかりませんでした
```

**原因**: 共有可能なディスプレイ、ウィンドウ、タブが見つかりません。

**対処法**:
1. ディスプレイが正しく接続されているか確認
2. 外部ディスプレイの場合、ケーブルを確認
3. システムを再起動

---

### エラー: AbortError

**症状**:
```
画面共有がキャンセルされました
```

**原因**: ユーザーが共有選択ダイアログで「キャンセル」をクリックしました。

**対処法**:
再度「画面共有を開始」ボタンをクリックして、共有したい画面/ウィンドウ/タブを選択してください。

---

## 画面が荒い・低解像度

### 症状

共有された画面の画質が悪い、ぼやけている。

### 原因と対処法

#### 1. 共有元の画面解像度が低い

**確認方法**:
ブラウザのコンソール（開発者ツール）を開き、以下のログを確認:
```
[ScreenCapture] Resolution: 1280x720 @ 30fps
```

**対処法 (macOS)**:
```
システム設定 > ディスプレイ > 解像度
```
- 「拡大」ではなく「スペースを拡大」側の解像度を選択
- Retinaディスプレイの場合、ネイティブ解像度を選択

**対処法 (Windows)**:
```
設定 > システム > ディスプレイ > ディスプレイの解像度
```
- 最大解像度を選択

#### 2. iPhone画面のミラーリング

iPhoneの画面をMacにミラーリングしている場合、iPhoneの解像度に制限されます。

**iPhone解像度**:
- iPhone 15 Pro Max: 1290 x 2796 (460 ppi)
- iPhone 15: 1179 x 2556 (460 ppi)
- iPhone SE: 750 x 1334 (326 ppi)

**対処法**: これはハードウェアの制限のため、改善できません。

#### 3. ブラウザのハードウェアアクセラレーションが無効

**対処法 (Chrome)**:
```
chrome://settings/ > システム > ハードウェアアクセラレーションが使用可能な場合は使用する
```
- ONにしてブラウザを再起動

**対処法 (Safari)**:
Safari は自動的にハードウェアアクセラレーションを使用します。

#### 4. CPUリソース不足

**確認方法**:
- アクティビティモニタ（macOS）またはタスクマネージャー（Windows）でCPU使用率を確認

**対処法**:
- 他のアプリケーションを閉じる
- バックグラウンドプロセスを終了
- ブラウザのタブを減らす

---

## パフォーマンスの問題

### 症状

動きがカクカクする、フレームレートが低い。

### 対処法

#### 1. フレームレートを確認

コンソールログで実際のフレームレートを確認:
```
[ScreenCapture] Resolution: 1920x1080 @ 30fps
```

30fps未満の場合、以下を試してください:

#### 2. 解像度を下げる

高解像度はCPU/GPUリソースを消費します。

共有する画面の解像度を下げるか、別の画面/ウィンドウを選択してください。

#### 3. ブラウザの拡張機能を無効化

不要な拡張機能がパフォーマンスに影響する場合があります。

**Chrome**:
- シークレットモードで試す（拡張機能が無効化される）

#### 4. 専用GPUを使用 (デュアルGPU環境)

MacBookなど、複数のGPUを搭載している場合:

```
システム設定 > バッテリー > 電源アダプタ接続時の自動グラフィックス切り替え
```
- OFFにして専用GPUを常時使用

---

## HTTPSエラー

### 症状

localhost以外でアクセスすると画面共有が動作しない。

### 原因

Screen Capture API はセキュリティ上の理由から、HTTPS または localhost でのみ動作します。

### 対処法

#### ローカルネットワークでの開発

開発用にHTTPSサーバーをセットアップ:

1. **自己署名証明書を作成**
   ```bash
   openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes
   ```

2. **Viteの設定を変更**

   `vite.config.ts` を作成:
   ```typescript
   import { defineConfig } from 'vite';
   import react from '@vitejs/plugin-react';
   import fs from 'fs';

   export default defineConfig({
     plugins: [react()],
     server: {
       https: {
         key: fs.readFileSync('key.pem'),
         cert: fs.readFileSync('cert.pem'),
       },
       host: true,
     },
   });
   ```

3. **開発サーバーを起動**
   ```bash
   npm run dev
   ```

   `https://localhost:5173/` でアクセス

#### プロダクション環境

プロダクション環境では必ずHTTPSを使用してください:
- Vercel、Netlify等のホスティングサービスは自動的にHTTPSを提供
- 独自ドメインの場合、Let's Encrypt等で証明書を取得

---

## セカンドポインターが表示されない

### 症状

第1/第2マウスを接続しても、ポインターが表示されない。

### 原因

この機能は現在UIのみ実装されており、実際のポインター表示機能は未実装です。

### 対処法

この機能は将来のバージョンで実装予定です。

---

## ビルドエラー

### TypeScriptエラー

**症状**:
```
error TS2322: Type 'X' is not assignable to type 'Y'
```

**対処法**:
1. `node_modules` を削除して再インストール
   ```bash
   rm -rf node_modules package-lock.json
   npm install
   ```

2. TypeScriptのバージョンを確認
   ```bash
   npm list typescript
   ```

---

## その他の問題

### 開発サーバーが起動しない

**対処法**:
```bash
# ポートが使用中の場合、別のポートで起動
npm run dev -- --port 3000
```

### ブラウザのコンソールログを確認

詳細なログが出力されるため、問題の特定に役立ちます:

```
[ScreenCapture] で始まるログを確認
```

---

## サポート

上記の方法で解決しない場合は、以下の情報を添えてIssueを作成してください:

- OS とバージョン
- ブラウザとバージョン
- エラーメッセージ
- コンソールログ（`[ScreenCapture]`で始まる行）
- 再現手順
